<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - Nayara</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css" rel="stylesheet" />

  <script>
    tailwind.config = { darkMode: "class" };

    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("theme") === "dark") {
        document.documentElement.classList.add("dark");
      }

      const user = JSON.parse(localStorage.getItem("sim_user"));
      if (!user || user.role.toLowerCase() !== "admin") {
        alert("â›” Access Denied");
        window.location.href = "/login.html";
      }
    });

    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function logout() {
      localStorage.clear();
      window.location.href = "/login.html";
    }
  </script>
</head>

<body class="min-h-screen flex bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-white">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-[#002f4b] text-white flex flex-col py-6 px-4">
    <div class="flex justify-center mb-6">
      <img src="nayara-logo.jpg" class="w-20 h-20 rounded-full" />
    </div>

    <h1 class="text-xl font-bold text-center mb-6">Admin Panel</h1>

    <nav class="space-y-4">
      <a class="flex items-center gap-2 p-2 hover:bg-white/10 rounded">
        <i class="bx bx-home"></i> Dashboard
      </a>

      <a href="/add-sim.html" class="flex items-center gap-2 p-2 hover:bg-white/10 rounded">
        <i class="bx bx-plus"></i> Add SIM
      </a>

      <a href="/assign-sim.html" class="flex items-center gap-2 p-2 hover:bg-white/10 rounded">
        <i class="bx bx-transfer"></i> Assign SIM
      </a>

      <button onclick="toggleTheme()" class="flex items-center gap-2 p-2 bg-white/10 rounded">
        <i class="bx bx-adjust"></i> Toggle Theme
      </button>

      <button onclick="logout()" class="mt-6 bg-red-600 hover:bg-red-700 p-2 rounded">
        <i class="bx bx-log-out"></i> Logout
      </button>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 p-8 space-y-6">

    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-semibold">Welcome Admin ðŸ‘‘</h2>
      <span class="bg-white dark:bg-gray-800 px-4 py-2 rounded">Role: Admin</span>
    </div>

    <!-- COUNTERS -->
    <div class="grid grid-cols-4 gap-4">
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <p>Total</p><p id="totalCount" class="text-2xl font-bold">--</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <p>Admin Pending</p><p id="pendingCount" class="text-xl text-yellow-500">--</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <p>Assigned</p><p id="approvedCount" class="text-xl text-green-500">--</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
        <p>Rejected</p><p id="rejectedCount" class="text-xl text-red-500">--</p>
      </div>
    </div>

    <!-- TABLE -->
    <section>
      <h3 class="text-xl font-semibold mb-4">SIM Requests</h3>

      <table class="w-full text-sm bg-white dark:bg-gray-800 rounded overflow-hidden">
        <thead class="bg-[#002f4b] text-white">
          <tr>
            <th class="p-2">Name</th>
            <th class="p-2">Mobile</th>
            <th class="p-2">Type</th>
            <th class="p-2">Status</th>
            <th class="p-2">Date</th>
            <th class="p-2">Action</th>
          </tr>
        </thead>
        <tbody id="adminTable"></tbody>
      </table>
    </section>

  </main>

  <!-- CONFIG -->
  <script src="config.js"></script>

  <script>
    const token = localStorage.getItem("token");
    
    async function loadRequests() {
      const res = await fetch(`${API_BASE_URL}/api/requests`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await res.json();

      // âœ… ADMIN SHOULD SEE ONLY THESE
      const adminRequests = data.filter(r =>
        r.status === "Admin Pending" || r.status === "SIM Assigned"
      );

      const table = document.getElementById("adminTable");
      table.innerHTML = "";

      let pending = 0, assigned = 0;

      adminRequests.forEach(req => {
        if (req.status === "Admin Pending") pending++;
        if (req.status === "SIM Assigned") assigned++;

        table.insertAdjacentHTML("beforeend", `
          <tr class="border-t">
            <td class="p-2">${req.employeeName}</td>
            <td class="p-2">${req.mobile}</td>
            <td class="p-2">${req.requestType}</td>
            <td class="p-2">${req.status}</td>
            <a
  href="https://sim-management-system-backend.onrender.com${req.document}"
  target="_blank"
  class="text-blue-600 underline">
  View Document
</a>


            <td class="p-2">${new Date(req.createdAt).toLocaleDateString()}</td>
            <td class="p-2">
              ${
                req.status === "Admin Pending"
                ? `<button onclick="assignSIM('${req._id}')" class="text-blue-600 hover:underline">
                     Assign SIM
                   </button>`
                : "â€”"
              }
            </td>
          </tr>
        `);
      });
      async function loadNotifications() {
  const res = await fetch(`${API_BASE_URL}/api/notifications`, {
    headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
  });

  const data = await res.json();
  const box = document.getElementById("notificationBox");
  box.innerHTML = "";

  data.forEach(n => {
    box.innerHTML += `
      <div class="p-3 border-b ${n.isRead ? 'opacity-60' : 'font-semibold'}">
        ${n.message}
        <div class="text-xs text-gray-500">
          ${new Date(n.createdAt).toLocaleString()}
        </div>
      </div>
    `;
  });
}
  loadNotifications();

      document.getElementById("totalCount").textContent = adminRequests.length;
      document.getElementById("pendingCount").textContent = pending;
      document.getElementById("approvedCount").textContent = assigned;
      document.getElementById("rejectedCount").textContent = 0;
    }

    function assignSIM(id) {
      localStorage.setItem("assignRequestId", id);
      window.location.href = "/assign-sim.html";
    }

    window.onload = loadRequests;
  </script>

</body>
</html>
